# V12 檔案和資源

## 控制目標

確保經過驗證的應用程式滿足以下高階要求：

* 不受信任的檔案資料應以安全的方式進行相應處理。
* 從不可信任的來源獲得的不可信任的檔案資料被儲存在Web目錄之外，並具有有限的許可權。

## V12.1 檔案上傳

儘管zip炸彈很容易使用滲透測試技術進行測試，但它們被認為是L2及以上級別，以鼓勵設計和開發時考慮仔細的人工測試，並避免對拒絕服務場景進行自動化或不熟練的手動滲透測試。

| # | 描述 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **12.1.1** | 確認應用程式不會接受可能會填滿儲存空間或導致拒絕服務的大檔案。 | ✓ | ✓ | ✓ | 400 |
| **12.1.2** | 驗證應用程式在解壓縮檔案前，根據允許的最大解壓縮尺寸和最大檔案數檢查壓縮檔案（如zip，gz，docx，odt）。 | | ✓ | ✓ | 409 |
| **12.1.3** | 驗證檔案大小配額和每個使用者的最大檔案數是否被強制執行，以確保單個使用者不能用過多的檔案或過大的檔案填滿儲存。 | | ✓ | ✓ | 770 |

## V12.2 檔案完整性

| # | 描述 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **12.2.1** | 驗證從不可信任的來源獲得的檔案，根據檔案的內容，驗證其是否為預期型別。 | | ✓ | ✓ | 434 |

## V12.3 檔案執行

| # | 描述 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **12.3.1** | 驗證系統或框架檔案系統不直接使用使用者提交的檔名元資料，並且使用 URL API 來防止路徑遍歷。 | ✓ | ✓ | ✓ | 22 |
| **12.3.2** | 驗證使用者提交的檔名元資料是否經過驗證或忽略，以防止通過本地檔案包含（LFI） 洩露、建立、更新或刪除本地檔案。 | ✓ | ✓ | ✓ | 73 |
| **12.3.3** | 驗證使用者提交的檔名元資料是否經過驗證或忽略，以防止通過遠端檔案包含（Remote File Inclusion，RFI）或伺服器端請求偽造攻擊（server - Server Side Request Forgery，SSRF）洩露或執行遠端檔案。 | ✓ | ✓ | ✓ | 98 |
| **12.3.4** | 驗證應用程式通過驗證或忽略使用者提交的JSON、JSONP或URL引數中的檔名來防止反射檔案下載（RFD），響應的Content-Type頭應該設定為 text/plain，而Content-Disposition頭應該有一個固定的檔名。 | ✓ | ✓ | ✓ | 641 |
| **12.3.5** | 驗證未受信任的檔案元資料不直接用於系統API或庫，以防止作業系統命令注入。 | ✓ | ✓ | ✓ | 78 |
| **12.3.6** | 驗證應用程式不包含或執行不可信任來源的功能，如未經驗證的內容分發網路、JavaScript 庫、node npm 庫或伺服器端 DLL。 | | ✓ | ✓ | 829 |

## V12.4 檔案儲存

| # | 描述 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **12.4.1** | 驗證從不受信任的來源獲得的檔案是否儲存在 Web 根目錄之外，並具有有限的許可權。 | ✓ | ✓ | ✓ | 552 |
| **12.4.2** | 驗證從不受信任的來源獲得的檔案是否已被防病毒掃描程式掃描，以防止上傳和提供已知的惡意內容。 | ✓ | ✓ | ✓ | 509 |

## V12.5 檔案下載

| # | 描述 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **12.5.1** | 驗證網路層是否被配置為只提供具有特定副檔名的檔案，以防止意外資訊和原始碼洩漏。例如，除非有需要，應阻止提供備份檔案（如.bak）、臨時工作檔案（如.swp）、壓縮檔案（.zip、.tar.gz等）以及其他編輯人員常用的副檔名。 | ✓ | ✓ | ✓ | 552 |
| **12.5.2** | 驗證對上傳檔案的直接請求永遠不會作為 HTML/JavaScript 內容執行。 | ✓ | ✓ | ✓ | 434 |

## V12.6 SSRF保護

| # | 說明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **12.6.1** | 驗證 Web 或應用程式伺服器是否配置了資源或系統的白名單列表，伺服器可以向其傳送請求或載入資料/檔案。 | ✓ | ✓ | ✓ | 918 |

## 參考文獻

有關更多資訊，請參閱：

* [File Extension Handling for Sensitive Information](https://owasp.org/www-community/vulnerabilities/Unrestricted_File_Upload)
* [Reflective file download by Oren Hafif](https://www.trustwave.com/Resources/SpiderLabs-Blog/Reflected-File-Download---A-New-Web-Attack-Vector/)
* [OWASP Third Party JavaScript Management Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Third_Party_Javascript_Management_Cheat_Sheet.html)
