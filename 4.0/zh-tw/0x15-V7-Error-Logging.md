# V7 錯誤處理和日誌記錄

## 控制目標

錯誤處理和記錄的主要目標，是為使用者、管理員和事件響應團隊提供有用的資訊。目標不是建立大量日誌，而是建立高質量的日誌，資訊多於丟棄的噪聲。

高質量的日誌往往包含敏感資料，必須按照當地的資料隱私法或指令進行保護。這應該包括：

* 除非特別要求，否則不收集或記錄敏感資訊。
* 確保所有記錄的資訊被安全地處理，並根據其資料分類進行保護。
* 確保日誌不會被永久儲存，而是有一個儘可能短的生命週期。

如果日誌包含私人或敏感資料（各國對這些資料的定義各不相同），則日誌將成為應用程式所持有的最敏感資訊之一，因此對攻擊者本身來說非常有吸引力。

同樣重要的是，要確保應用程式安全地故障，而且錯誤不會洩露不必要的資訊。

## V7.1 日誌內容

記錄敏感資訊是很危險的——日誌本身就成了機密，這意味著它們需要被加密，成為保留政策的物件，並且必須在安全審計中被披露。確保只有必要的資訊被儲存在日誌中，當然沒有支付、憑證（包括會話令牌）、敏感或個人身份資訊。

V7.1 涵蓋了 OWASP Top 10 2017:A10. 由於 2017:A10 和本節不可通過滲透測試來驗證，重要的是：

* 開發人員要確保完全遵守本節，就像所有專案都被標記為L1一樣。
* 滲透測試人員通過訪談，螢幕截圖或斷言來驗證 V7.1 中所有專案的完全合規性。

| # | 描述 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **7.1.1** | 驗證應用程式不記錄憑證或支付細節。會話令牌應該只以不可逆的雜湊形式儲存在日誌中。 ([C9, C10](https://owasp.org/www-project-proactive-controls/#div-numbering)) | ✓ | ✓ | ✓ | 532 |
| **7.1.2** | 驗證應用程式不會記錄當地隱私法或相關安全政策規定的其他敏感資料。 ([C9](https://owasp.org/www-project-proactive-controls/#div-numbering)) | ✓ | ✓ | ✓ | 532 |
| **7.1.3** | 驗證應用程式是否記錄安全相關事件，例如成功和失敗的認證事件、訪問控制失敗、反序列化失敗和輸入驗證失敗的事件。 ([C5, C7](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 778 |
| **7.1.4** | 驗證每個日誌事件都包含必要的資訊，以便在事件發生後詳細調查時間軸。 ([C9](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 778 |

## V7.2 日誌處理

及時的日誌記錄對於事件的審計、研判和升級是至關重要的。確保應用程式的日誌是清晰的，可以很容易地在本地監測和分析，或將日誌傳送到遠端監控系統。

V7.2 涵蓋了 OWASP Top 10 2017:A10. 由於 2017:A10 和本節不可通過滲透測試來驗證，重要的是：

* 開發人員要確保完全遵守本節，就像所有專案都被標記為L1一樣。
* 滲透測試人員通過訪談，螢幕截圖或斷言來驗證 V7.2 中所有專案的完全合規性。

| # | 描述 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **7.2.1** | 驗證所有的認證決策都被記錄下來，不儲存敏感的會話令牌或密碼。這應該包括安全調查所需的具有相關元資料的請求。 | | ✓ | ✓ | 778 |
| **7.2.2** | 驗證是否可以記錄所有訪問控制決策並記錄所有失敗的決策。這應包括安全調查所需的具有相關元資料的請求。 | | ✓ | ✓ | 285 |

## V7.3 日誌保護

可以輕易修改或刪除的日誌，對於調查和起訴毫無用處。日誌的披露可能會暴露有關應用程式或其包含的資料的內部細節。在保護日誌免遭未經授權的披露、修改或刪除時，必須小心謹慎。

| # | 描述 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **7.3.1** | 驗證所有日誌元件是否對資料進行了適當的編碼，以防止日誌注入。 ([C9](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 117 |
| **7.3.2** | [已刪除，與 7.3.1 重複] | | | | |
| **7.3.3** | 驗證安全日誌是否受到保護，防止未授權的訪問或修改。 ([C9](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 200 |
| **7.3.4** | 驗證時間源是否同步到正確的時間和時區。如果系統是全球性的，強烈考慮只用UTC來記錄，以協助事件後的取證分析。 ([C9](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | |

注意：日誌編碼（7.3.1）很難使用自動化工具和滲透測試進行測試和審查，但架構師、開發人員和原始碼審查人員應將其視為 L1 要求。


## V7.4 錯誤處理

錯誤處理的目的，是允許應用程式提供與安全有關的事件，用於監控、研判和升級。目的不是為了建立日誌。當記錄安全相關的事件時，要確保日誌有其目的，並且可以被SIEM或分析軟體識別。

| # | 描述 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **7.4.1** | 驗證在發生意外或安全敏感錯誤時，是否顯示通用資訊，可能帶有支援人員可以用於調查的唯一ID。 ([C10](https://owasp.org/www-project-proactive-controls/#div-numbering)) | ✓ | ✓ | ✓ | 210 |
| **7.4.2** | 驗證整個程式碼庫是否使用了異常處理（或類似功能），以說明預期和非預期的錯誤情況。 ([C10](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 544 |
| **7.4.3** | 驗證是否定義了“最後手段”的錯誤處理程式，以捕獲所有未處理的異常。 ([C10](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 431 |

注意：某些語言，例如 Swift 和 Go ——以及通過常見的設計實踐——許多函式式語言，不支援異常或最後的事件處理程式。在這種情況下，架構師和開發人員應該使用一種模式、語言或框架友好的方式，來確保應用程式能夠安全地處理異常、意外或安全相關的事件。

## 參考文獻

有關更多資訊，請參閱：

* [OWASP Testing Guide 4.0 content: Testing for Error Handling](https://owasp.org/www-project-web-security-testing-guide/v41/4-Web_Application_Security_Testing/08-Testing_for_Error_Handling/README.html)
* [OWASP Authentication Cheat Sheet section about error messages](https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html#authentication-and-error-messages)
