# V3 會話管理

## 控制目標

任何基於Web的應用程式或有狀態的API的核心組成部分之一，是它控制和維護與之互動的使用者或裝置的狀態的機制。會話管理將無狀態協議變為有狀態協議，這對於區分不同的使用者或裝置至關重要。

確保經過驗證的應用程式滿足以下高階會話管理需求:

* 會話對每個人都是唯一的，不能被猜測或共享。
* 會話在不再需要時失效，在不活動期間超時。

如前所述，這些要求已被調整為符合 NIST 800-63b 控制的一個子集，重點關注常見的威脅和經常被利用的認證弱點。 以前的驗證要求已被淘汰、去重，或者在大多數情況下已調整為與強制性 [NIST 800-63b](https://pages.nist.gov/800-63-3/sp800-63b.html) 要求的意圖保持高度一致。

## 安全驗證要求

## V3.1 基本會話管理安全

| # | 說明 | L1 | L2 | L3 | CWE | [NIST &sect;](https://pages.nist.gov/800-63-3/sp800-63b.html) |
| :---: | :--- | :---: | :---: | :---: | :---: | :---: |
| **3.1.1** | 驗證應用不會在URL引數中顯示會話令牌。 | ✓ | ✓ | ✓ | 598 | |

## V3.2 會話繫結

| # | 說明 | L1 | L2 | L3 | CWE | [NIST &sect;](https://pages.nist.gov/800-63-3/sp800-63b.html) |
| :---: | :--- | :---: | :---: | :---: | :---: | :---: |
| **3.2.1** | 驗證應用程式在使用者身份驗證時，生成新的會話令牌。 ([C6](https://owasp.org/www-project-proactive-controls/#div-numbering)) | ✓ | ✓ | ✓ | 384 | 7.1 |
| **3.2.2** | 驗證會話令牌具有至少 64 位的熵。 ([C6](https://owasp.org/www-project-proactive-controls/#div-numbering)) | ✓ | ✓ | ✓ | 331 | 7.1 |
| **3.2.3** | 驗證應用程式僅使用安全方法在瀏覽器中儲存會話令牌，例如適當的 cookie保護（參見第 3.4 節）或 HTML 5 會話儲存。 | ✓ | ✓ | ✓ | 539 | 7.1 |
| **3.2.4** | 驗證會話令牌是使用批准的加密演算法生成的。 ([C6](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 331 | 7.1 |

會話管理必須使用 TLS 或其他安全傳輸通道。這在“通訊安全”一章中有介紹。

## V3.3 會話終止

會話超時已經與NIST 800-63保持一致，它允許比傳統安全標準所允許的更長的會話超時。組織應查看下錶，如果應用的風險需要更長的超時，NIST值應是會話空閒超時的上限。

在此上下文中，L1 是 IAL1/AAL1，L2 是 IAL2/AAL3，L3 是 IAL3/AAL3。對於 IAL2/AAL2 和 IAL3/AAL3，空閒超時時間越短，表示登出或重新認證恢復會話的時間越短。

| # | 說明 | L1 | L2 | L3 | CWE | [NIST &sect;](https://pages.nist.gov/800-63-3/sp800-63b.html) |
| :---: | :--- | :---: | :---: | :---: | :---: | :---: |
| **3.3.1** | 驗證登出和到期是否會使會話令牌無效，以便後退按鈕或下游依賴方不會恢復經身份驗證過的會話。 ([C6](https://owasp.org/www-project-proactive-controls/#div-numbering)) | ✓ | ✓ | ✓ | 613 | 7.1 |
| **3.3.2** | 如果認證器允許使用者保持登入狀態，請驗證在活躍使用或空閒一段時間過後，定期進行重新認證。 ([C6](https://owasp.org/www-project-proactive-controls/#div-numbering)) | 30天 | 12小時 或 30分鐘不活動，可選2FA | 12小時 或 15 分鐘不活動，使用2FA | 613 | 7.2 |
| **3.3.3** | 驗證應用程式是否提供了在成功更改密碼（包括通過密碼重置/恢復）後終止所有其他活動會話的選項，並且這在應用程式、聯合登入（如果存在）和任何依賴方中都是有效的。 | | ✓ | ✓ | 613 | |
| **3.3.4** | 驗證使用者能夠檢視並（在重新輸入登入憑證後）登出當前的所有活動會話和裝置。 | | ✓ | ✓ | 613 | 7.1 |

## V3.4 基於 Cookie 的會話管理

| # | 說明 | L1 | L2 | L3 | CWE | [NIST &sect;](https://pages.nist.gov/800-63-3/sp800-63b.html) |
| :---: | :--- | :---: | :---: | :---: | :---: | :---: |
| **3.4.1** | 驗證基於 cookie 的會話令牌是否設定了'Secure'屬性。 ([C6](https://owasp.org/www-project-proactive-controls/#div-numbering)) | ✓ | ✓ | ✓ | 614 | 7.1.1 |
| **3.4.2** | 驗證基於 cookie 的會話令牌是否設定了'HttpOnly'屬性。 ([C6](https://owasp.org/www-project-proactive-controls/#div-numbering)) | ✓ | ✓ | ✓ | 1004 | 7.1.1 |
| **3.4.3** | 驗證基於cookie的會話令牌是否使用了'SameSite'屬性，以限制跨站點請求偽造攻擊（CSRF）的風險。 ([C6](https://owasp.org/www-project-proactive-controls/#div-numbering)) | ✓ | ✓ | ✓ | 16 | 7.1.1 |
| **3.4.4** | 驗證基於cookie的會話令牌是否使用'__Host-'字首，這樣cookie只會被髮送到最初設定cookie的主機。 | ✓ | ✓ | ✓ | 16 | 7.1.1 |
| **3.4.5** | 驗證如果應用程式在一個域名下發布，而其他應用程式設定或使用會話cookie（這可能會洩露會話cookie），則在基於cookie的會話令牌中設定路徑屬性（Path），儘可能使用最精確的路徑。 ([C6](https://owasp.org/www-project-proactive-controls/#div-numbering)) | ✓ | ✓ | ✓ | 16 | 7.1.1 |

## V3.5 基於令牌的會話管理

基於令牌的會話管理包括JWT、OAuth、SAML和API金鑰。其中，API金鑰公認較弱，不應該在新程式碼中使用。

| # | 說明 | L1 | L2 | L3 | CWE | [NIST &sect;](https://pages.nist.gov/800-63-3/sp800-63b.html) |
| :---: | :--- | :---: | :---: | :---: | :---: | :---: |
| **3.5.1** | 驗證該應用允許使用者撤銷與連結應用建立信任關係的OAuth令牌。 | | ✓ | ✓ | 290 | 7.1.2 |
| **3.5.2** | 驗證應用程式使用會話令牌，而不是靜態API密碼或金鑰，舊的實現除外。 | | ✓ | ✓ | 798 | |
| **3.5.3** | 驗證無狀態會話令牌是否使用數字簽名、加密等對策，來防止篡改、封裝、重放、空密碼和金鑰替換等攻擊。 | | ✓ | ✓ | 345 | |

## V3.6 聯合重認證

本節與那些編寫依賴方（RP）或憑證服務提供商（CSP）程式碼的人員有關。如果依賴於實現這些功能的程式碼，請確保正確處理這些問題。

| # | 說明 | L1 | L2 | L3 | CWE | [NIST &sect;](https://pages.nist.gov/800-63-3/sp800-63b.html) |
| :---: | :--- | :---: | :---: | :---: | :---: | :---: |
| **3.6.1** | 驗證依賴方（RP）是否指定了憑證服務提供商（CSP）的最長身份驗證時間，並且如果使用者在該期間內未使用會話，CSP是否會重新驗證使用者。 | | | ✓ | 613 | 7.2.1 |
| **3.6.2** | 驗證憑證服務提供商（CSP）通知依賴方（RP）最後一次認證事件，以便 RP 確定他們是否需要重新認證使用者。 | | | ✓ | 613 | 7.2.1 |

## V3.7 針對會話管理漏洞的防禦措施

已知的一些會話管理漏洞，與會話的使用者體驗（UX）相關。以前，根據 ISO 27002 要求，ASVS 需要阻止多個併發會話。 現在，阻止併發會話已不再合適，不僅因為現代使用者有許多裝置，或者應用程式是沒有瀏覽器會話的 API，還因為在大多數這些實現中，最後一個身份驗證者獲勝，這通常是攻擊者。本小節提供了使用程式碼阻止、延遲和檢測會話管理攻擊的主要指導。

### 半開放攻擊的描述

在2018年初，一些金融機構遭到了攻擊者所謂的“半開放攻擊”（half-open attacks）。這個術語在行業中一直存在。攻擊者以不同的專有程式碼庫攻擊了多家機構，實際上，在同一個機構中似乎也有不同的程式碼庫。這種“半開放攻擊”利用了許多現有認證、會話管理和訪問控制系統中常見的設計模式缺陷。

攻擊者通過試圖鎖定、重置或恢復一個憑證來開始半開放攻擊。流行的會話管理設計模式，在未認證、半認證（密碼重置、忘記使用者名稱）和完全認證的程式碼之間，重用使用者配置檔案會話物件/模型。 這種設計模式會填充一個有效的會話物件或令牌，其中包含受害者的個人資料，包括密碼雜湊值和角色。如果訪問控制檢查在控制器或路由器沒有正確驗證使用者是完全登入，攻擊者將能夠冒充使用者。攻擊手段可能包括：將使用者的密碼更改為已知值、更新電子郵件地址以執行有效的密碼重置、禁用多因素身份驗證或註冊新的MFA裝置、暴露或更改API金鑰等。

| # | 說明 | L1 | L2 | L3 | CWE | [NIST &sect;](https://pages.nist.gov/800-63-3/sp800-63b.html) |
| :---: | :--- | :---: | :---: | :---: | :---: | :---: |
| **3.7.1** | 在允許任何敏感交易或帳戶修改之前，驗證應用程式確保完整、有效的登入會話，或要求重新驗證（二次驗證）。 | ✓ | ✓ | ✓ | 306 | |

## 參考文獻

有關更多資訊，請參閱：

* [OWASP Testing Guide 4.0: Session Management Testing](https://owasp.org/www-project-web-security-testing-guide/v41/4-Web_Application_Security_Testing/06-Session_Management_Testing/README.html)
* [OWASP Session Management Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Session_Management_Cheat_Sheet.html)
* [Set-Cookie __Host- prefix details](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie#Directives)
