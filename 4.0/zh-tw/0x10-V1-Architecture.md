# V1 架構、設計和威脅建模

## 控制目標

在許多組織中，安全架構幾乎已成為一門失傳的藝術。 在DevSecOps時代，企業架構師的日子已經過去。應用安全領域必須迎頭趕上，採用敏捷安全原則，同時將領先的安全架構原則重新介紹給軟體從業者。 A架構不是一種實施，而是一種思考問題的方式，它可能有許多不同的答案，而沒有一個單一的“正確”答案。 很多時候，安全被視為不靈活的，要求開發人員以特定方式修復程式碼，而開發人員可能知道解決問題的更好方法。 對於架構來說，沒有單一的、簡單的解決方案，嘗試尋找這種方案，是對軟體工程領域的一種損害。

一個Web應用程式的具體實現，很可能在其生命週期中不斷被修改，但整體架構可能很少改變，而是緩慢發展。 安全架構也是一樣的，身份驗證——我們今天需要、明天需要、五年後也需要。 如果我們今天做出合理的決定，選擇和複用符合架構的解決方案，那麼就可以節省大量的精力、時間和金錢。 例如，十年前，多因素認證很少被實施。

如果開發人員已經在單一的“安全標識提供程式模型”上有所投入（例如SAML聯邦認證），身份提供者可以更新以納入新的要求（例如NIST 800-63標準），同時不改變原始應用程式的介面。 如果許多應用程式共享相同的安全架構和元件，那麼它們都將同時從這次升級中受益。 然而，SAML 並不總是最好或最合適的身份驗證解決方案——隨著需求的變化，可能需要替換為其他解決方案。 像這樣的更改要麼很複雜，成本高到需要完全重寫，要麼在沒有安全架構的情況下完全不可能。

在本章中，ASVS涵蓋了任何良好安全架構的主要方面：可用性、保密性、完整性、不可抵賴性和隱私。 這些安全原則中的每一條，都必須適用並內置於所有應用程式中。 “左移”至關重要，從安全編碼Checklists、指導和培訓、編碼和測試、構建、部署、配置和操作開始，到後續的獨立測試，確保所有安全控制存在且功能正常。 這最後一步，曾經是我們作為一個行業所做的一切，但當開發人員每天數十次或數百次地推送程式碼時，就已經不夠了。 應用安全專業人員必須跟上敏捷技術的步伐，這意味著要適應開發人員的工具，學習編碼，並與開發人員一起工作，而不是在其他人離開的幾個月後再批評專案。

## V1.1 安全軟體開發生命週期

| # | 說明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **1.1.1** | 驗證使用安全的軟體開發生命週期，在開發的各個階段解決安全問題。 ([C1](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | |
| **1.1.2** | 驗證在每次設計變更或sprint計劃中使用威脅建模，以識別威脅、計劃對策、促進適當的風險響應，並指導安全測試。 | | ✓ | ✓ | 1053 |
| **1.1.3** | 驗證所有使用者資訊和功能是否包含功能安全約束，例如 “作為一個使用者，我應該能夠檢視和編輯我的個人資料。我不應該能夠檢視或編輯其他人的資料” | | ✓ | ✓ | 1110 |
| **1.1.4** | 驗證應用程式所有的信任邊界、元件和重要資料流的文件，判斷其合理性。 | | ✓ | ✓ | 1059 |
| **1.1.5** | 驗證應用程式的高階架構及遠端連線服務涉及的定義和安全分析。 ([C1](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 1059 |
| **1.1.6** | 驗證集中、簡單（設計）、安全、經過審查、和可重複使用的安全控制措施的實施情況，以避免重複、缺失、無效或不安全的控制措施。 ([C10](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 637 |
| **1.1.7** | 向所有開發人員和測試人員，驗證安全編碼Checklist、安全需求、指南或策略的可用性。 | | ✓ | ✓ | 637 |

## V1.2 認證架構

在設計身份驗證時，如果攻擊者可以通過撥打客服電話，回答常見的問題來重置帳戶，那麼是否具有強大硬體支援的多因素身份驗證（MFA）並不重要。 在證明身份時，所有的認證途徑必須具有相同的強度。

| # | 說明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **1.2.1** | 驗證應用程式所有的元件、服務和伺服器，是否使用了唯一或特殊的低許可權作業系統帳戶。 ([C3](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 250 |
| **1.2.2** | 驗證應用元件之間（包括 API、中介軟體和資料層）的通訊是否經過驗證。元件只具有最低的必要許可權。 ([C3](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 306 |
| **1.2.3** | 驗證應用程式是否使用已知安全的單一認證機制，可以擴充套件到強身份驗證，並有足夠的日誌記錄和監控，來檢測帳戶濫用或違規行為。 | | ✓ | ✓ | 306 |
| **1.2.4** | 驗證所有的認證途徑和身份管理 API ，都實現了一致的認證安全控制強度， 以便收斂應用程式的風險。 | | ✓ | ✓ | 306 |

## V1.3 會話管理架構

這是未來架構需求的佔位符。

## V1.4 訪問控制架構

| # | 說明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **1.4.1** | 驗證受信任的實施點（如訪問控制閘道器、伺服器和Serverless函式）是否實施了訪問控制。切勿在客戶端實施訪問控制。 | | ✓ | ✓ | 602 |
| **1.4.2** | [已刪除，不可操作] | | | | |
| **1.4.3** | [已刪除，與 4.1.3 重複] | | | | |
| **1.4.4** | 驗證應用程式使用單一的、經過嚴格審查的訪問控制機制，來訪問受保護的資料和資源。 所有請求都必須通過這個單一機制，以避免複製、貼上或不安全的替代路徑。 ([C7](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 284 |
| **1.4.5** | 驗證是否使用基於屬性/特徵的訪問控制，即程式碼應檢查使用者對某一特徵/資料項的授權，而不僅僅是他們的角色。 許可權仍應依照不同角色進行分配。 ([C7](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 275 |

## V1.5 輸入和輸出架構

在4.0中，我們已經不再把 “伺服器端” 作為一個表示信任邊界的術語。 信任邊界仍然令人擔憂——在不受信任的瀏覽器或客戶端裝置上做決定，很容易被繞過的。 然而，在今天的主流架構部署中，信任的執行點已經發生了巨大的變化。 因此，在 ASVS 中使用 “受信任的服務層” 這一術語時，我們描述的都是受信任的執行點，無論其位置如何，如微服務、Serverless API、伺服器端、具有安全啟動的客戶端裝置上的受信任的API、合作伙伴或外部API等等。

這裡的“不受信任的客戶端”一詞，是指呈現表示層的客戶端技術，通常稱為“前端”技術。 這裡的術語“序列化”不僅表示通過網路傳送資料（如一個數組的值或獲取 JSON 結構），還指傳遞可以包含邏輯的複雜物件。

| # | 說明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **1.5.1** | 驗證輸入和輸出要求，明確規定如何根據型別、內容以及適用的法律、法規和其他政策規定，來操作和處理資料。 | | ✓ | ✓ | 1029 |
| **1.5.2** | 驗證在與不受信任的客戶進行通訊時，不使用序列化。 如果無法做到這一點，請確保執行足夠的完整性控制（如果傳送敏感資料，可能還要進行加密），以防止反序列化攻擊，包括物件注入。 | | ✓ | ✓ | 502 |
| **1.5.3** | 驗證輸入驗證是否在可信的服務層上執行。 ([C5](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 602 |
| **1.5.4** | 驗證輸出編碼是否發生在其預期的直譯器附近（或由直譯器進行）。 ([C4](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 116 |

## V1.6 加密架構

應用程式需要設計強大的加密架構，以根據其分類保護資料資產。加密所有東西，是浪費；不加密任何東西，是法律上的疏忽。 在架構或頂層設計、設計衝刺（Design Sprint）或架構高峰期，通常需要取得一種平衡。 一邊設計加密技術，一邊進行開發迭代，這樣的安全實施，其成本不可避免地要比一開始就做簡單的構建要高得多。

架構要求是整個程式碼庫的內在要求，因此很難進行單元或整合測試。架構需求需要在整個編碼階段的編碼標準中加以考慮，並應在安全架構、程式碼審查或覆盤會議中加以審查。

| # | 說明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **1.6.1** | 驗證是否有明確的加密金鑰管理政策，以及加密金鑰的生命週期是否遵循金鑰管理標準，如NIST SP 800-57。 | | ✓ | ✓ | 320 |
| **1.6.2** | 驗證密碼服務的消費者是否通過使用金鑰庫或基於API的替代方案，來保護金鑰材料和其他機密。 | | ✓ | ✓ | 320 |
| **1.6.3** | 驗證所有的金鑰和密碼是否可替換的，並且是重新加密敏感資料的明確定義流程的一部分。 | | ✓ | ✓ | 320 |
| **1.6.4** | 驗證架構是否將客戶端機密（例如對稱金鑰、密碼或 API 令牌）視為不安全的，並且從不使用它們來保護或訪問敏感資料。 | | ✓ | ✓ | 320 |

## V1.7 錯誤、日誌和審計架構

| # | 說明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **1.7.1** | 驗證整個系統是否使用了通用的日誌記錄格式和方法。 ([C9](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 1009 |
| **1.7.2** | 驗證日誌是否安全地傳輸到遠端系統，以便進行分析、檢測、報警和升級。 ([C9](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | |

## V1.8 資料保護和隱私架構

| # | 說明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **1.8.1** | 驗證所有敏感資料都已識別並歸入保護級別。 | | ✓ | ✓ | |
| **1.8.2** | 驗證所有保護級別都具有一套相關的保護要求，如加密要求、完整性要求、保留、隱私和其他機密性要求，並在架構中應用這些要求。 | | ✓ | ✓ | |

## V1.9 通訊架構

| # | 說明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **1.9.1** | 驗證應用程式對元件之間的通訊進行加密，特別是當這些元件處於不同的容器、系統、站點或雲提供商時。 ([C3](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 319 |
| **1.9.2** | 驗證應用元件是否驗證了通訊連結中每一方的真實性，以防止中間人攻擊。例如，應用程式元件應校驗TLS證書鏈。 | | ✓ | ✓ | 295 |

## V1.10 惡意軟體架構

| # | 說明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **1.10.1** | 驗證是否使用了原始碼控制系統，以及有程式確保簽入時附帶問題或變更單。原始碼控制系統應該具有訪問控制和可識別的使用者，以追溯任何的更改。 | | ✓ | ✓ | 284 |

## V1.11 業務邏輯架構

| # | 說明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **1.11.1** | 驗證所有應用元件在其提供的業務或安全功能方面的定義和文件。 | | ✓ | ✓ | 1059 |
| **1.11.2** | 驗證所有高價值的業務邏輯流，包括認證、會話管理和訪問控制，不共享不同步的狀態。 | | ✓ | ✓ | 362 |
| **1.11.3** | 驗證所有高價值的業務邏輯流，包括身份驗證、會話管理和訪問控制都是執行緒安全的，並能抵抗檢查時間和使用時間不同步時的條件競爭。 | | | ✓ | 367 |

## V1.12 安全上傳架構

| # | 說明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **1.12.1** | [已刪除，與 12.4.1 重複] | | | | |
| **1.12.2** | 驗證使用者上傳的檔案——如果需要顯示或從應用中下載，是通過二進位制流下載，或從無關的域（如雲檔案儲存桶）提供。實施合適的內容安全策略（CSP），以減少來自上傳檔案的XSS向量或其他攻擊的風險。 | | ✓ | ✓ | 646 |

## V1.13 API架構

這是未來架構需求的佔位符。

## V1.14 配置架構

| # | 說明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **1.14.1** | 通過明確的安全控制、防火牆規則、API 閘道器、反向代理、基於雲的安全組或類似機制，驗證不同信任級別的元件的隔離情況。 | | ✓ | ✓ | 923 |
| **1.14.2** | 驗證二進位制簽名、可信連線和經過驗證的介面，以將二進位制檔案部署到遠端裝置。 | | ✓ | ✓ | 494 |
| **1.14.3** | 驗證構建管道是否對過期或不安全的元件發出警告並採取適當的行動。 | | ✓ | ✓ | 1104 |
| **1.14.4** | 驗證構建管道是否包含自動構建和驗證應用安全部署的構建步驟，特別是當應用基礎設施是軟體定義時，例如雲環境構建指令碼。 | | ✓ | ✓ | |
| **1.14.5** | 驗證應用程式部署是否在網路級別進行了充分的沙盒化、容器化或隔離，以延遲和阻止攻擊者攻擊其他應用程式，尤其是當攻擊者執行敏感或危險操作時（如反序列化）。 ([C5](https://owasp.org/www-project-proactive-controls/#div-numbering)) | | ✓ | ✓ | 265 |
| **1.14.6** | 驗證應用程式未使用不受支援、不安全或不推薦的客戶端技術，如NSAPI外掛、Flash、Shockwave、ActiveX、Silverlight、NACL或客戶端Java applets。 | | ✓ | ✓ | 477 |

## 參考文獻

有關更多資訊，請參閱：

* [OWASP Threat Modeling Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Threat_Modeling_Cheat_Sheet.html)
* [OWASP Attack Surface Analysis Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Attack_Surface_Analysis_Cheat_Sheet.html)
* [OWASP Threat modeling](https://owasp.org/www-community/Application_Threat_Modeling)
* [OWASP Software Assurance Maturity Model Project](https://owasp.org/www-project-samm/)
* [Microsoft SDL](https://www.microsoft.com/en-us/sdl/)
* [NIST SP 800-57](https://csrc.nist.gov/publications/detail/sp/800-57-part-1/rev-5/final)
